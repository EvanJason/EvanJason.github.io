<!doctype html><html class="" data-reactroot=""><head><link rel="shortcut icon" href="https://willern.gitee.io/img/favicon.ico"/>
<meta data-react-helmet="true" charset="utf-8"/><meta data-react-helmet="true" http-equiv="x-ua-compatible" content="ie=edge"/><meta data-react-helmet="true" name="description" content="前端技术讨论交流，知识杂谈，生活分享。"/><meta data-react-helmet="true" name="viewport" content="width=device-width, initial-scale=1"/><meta data-react-helmet="true" property="og:title" content="使用 Angular RouteReuseStrategy 缓存组件 · 深海如梦的作战实践基地"/><meta data-react-helmet="true" property="og:description" content="前端技术讨论交流，知识杂谈，生活分享。"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary"/>
<title data-react-helmet="true">使用 Angular RouteReuseStrategy 缓存组件 · 深海如梦的作战实践基地</title>
<link data-react-helmet="true" rel="stylesheet" href="/assets/index.css"/><link data-react-helmet="true" id="prismTheme" rel="stylesheet" href="/assets/prism.css"/>
<script data-react-helmet="true" >
    const shouldSetIsDark = document.cookie.includes('is_dark=1') ? true : document.cookie.includes('is_dark=0') ? false : window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (shouldSetIsDark) {
      document.documentElement.classList.add('is_dark');
      document.getElementById('prismTheme').href = "/assets/prism_tomorrow.css";
    }
  </script>
</head><body><a class="czs-menu-l show_on_mobile aside_button_open" href="#" style="background-image:url(&quot;/assets/czs-menu-l.svg&quot;)"></a><a class="show_on_mobile aside_button_text" href="/">深海如梦的作战实践基地</a><aside class="hide_on_mobile"><div class="aside_card"><a class="czs-menu-l show_on_mobile aside_button_close" href="#" style="background-image:url(&quot;/assets/czs-close-l.svg&quot;)"></a><h1><a href="/">深海如梦的作战实践基地</a></h1><p class="description">前端技术讨论交流，知识杂谈，生活分享。</p><ul class="social list_style_none"><li class="flex_center"><a class="czs-github-logo" href="https://github.com/yourhug" target="_blank" style="background-image:url(&quot;/assets/czs-github-logo.svg&quot;)"></a></li><li class="flex_center"><a class="czs-message-l" href="mailto:linkenmum@163.com" target="_blank" style="background-image:url(&quot;/assets/czs-message-l.svg&quot;)"></a></li><li style="flex-grow:1"></li><li class="toggle_dark flex_center"><span class="czs-sun" style="background-image:url(&quot;/assets/czs-sun.svg&quot;)"></span><span class="czs-sun-l" style="background-image:url(&quot;/assets/czs-sun-l.svg&quot;)"></span><span class="czs-moon" style="background-image:url(&quot;/assets/czs-moon.svg&quot;)"></span><span class="czs-moon-l" style="background-image:url(&quot;/assets/czs-moon-l.svg&quot;)"></span></li></ul><nav><ul class="menu list_style_none"><li><a class="flex_center" href="/"><span class="czs-home-l" style="background-image:url(&quot;/assets/czs-home-l.svg&quot;)"></span>首页</a></li><li><a class="flex_center" href="/categories/"><span class="czs-category-l" style="background-image:url(&quot;/assets/czs-category-l.svg&quot;)"></span>分类</a></li><li><a class="flex_center" href="/tags/"><span class="czs-tag-l" style="background-image:url(&quot;/assets/czs-tag-l.svg&quot;)"></span>标签</a></li><li><a class="flex_center" href="/about/"><span class="czs-about-l" style="background-image:url(&quot;/assets/czs-about-l.svg&quot;)"></span>关于</a></li><li><a class="flex_center" href="/archives/"><span class="czs-box-l" style="background-image:url(&quot;/assets/czs-box-l.svg&quot;)"></span>归档</a></li><li><a class="flex_center" href="/links/"><span class="czs-link-l" style="background-image:url(&quot;/assets/czs-link-l.svg&quot;)"></span>友情链接</a></li></ul></nav></div><nav class="toc"><ol><li><a href="#routereusestrategy%E6%98%AF%E4%BB%80%E4%B9%88">RouteReuseStrategy是什么</a><ol></ol></li><li><a href="#%E7%A4%BA%E4%BE%8B">示例</a></li><li><a href="#%E6%95%88%E6%9E%9C%E5%9B%BE">效果图</a></li></ol></nav></aside><section class="main"><h1>使用 Angular RouteReuseStrategy 缓存组件</h1><div class="main_post_meta"><time dateTime="2020/10/29">2020-10-29</time> · <!-- -->深海如梦</div><article><p>记录在项目中需求所需要的功能点实现。</p>
<p><a href="https://angular.cn/api/router/RouteReuseStrategy">RouteReuseStrategy</a> provider 允许我们控制 Angular 路由和组件生命周期的行为。</p>
<p>当我们在组件间切换的时候，Angular都会销毁上一个组件，并且创建一个新的组件。在大多数情况下，我们可能不想让它这样工作，因为每次加载一个组件，可能会有很多类似HTTP请求一样的昂贵的操作。</p>
<p>这时候就需要RouteReuseStrategy了。</p>
<h3 id="routereusestrategy%E6%98%AF%E4%BB%80%E4%B9%88">RouteReuseStrategy是什么<a class="anchor" href="#routereusestrategy%E6%98%AF%E4%BB%80%E4%B9%88">§</a></h3>
<p>RouteReuseStrategy接口声明了5个方法。</p>
<h4 id="shouldreuseroute">shouldReuseRoute<a class="anchor" href="#shouldreuseroute">§</a></h4>
<p>这个方法每次切换路由时都会被调用。<code>future</code>参数是将要离开的路由，<code>curr</code>参数是将要加载的路由。如果这个方法返回<code>true</code>，路由将不会跳转（意味着路由没有发生变化）。如果它返回<code>false</code>，则路由发生变化并且其余方法会被调用。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">shouldReuseRoute</span><span class="token punctuation">(</span>future<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> curr<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认行为</span>
    <span class="token keyword">return</span> future<span class="token punctuation">.</span>routeConfig <span class="token operator">===</span> curr<span class="token punctuation">.</span>routeConfig<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="shouldattach">shouldAttach<a class="anchor" href="#shouldattach">§</a></h4>
<p>路由刚刚被打开，当我们加载到这个路由的组件上时，<code>shouldAttach</code>会被调用。一旦组件被加载这个方法都会被调用。如果这个方法返回<code>true</code>，<code>retrieve</code>方法将会被调用。否则这个组件将会被重新创建。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">shouldAttach</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="retrieve">retrieve<a class="anchor" href="#retrieve">§</a></h4>
<p>当<code>shouldAttach</code>方法返回<code>true</code>时这个方法会被调用。提供当前路由的参数（刚打开的路由），并且返回一个缓存的<code>RouteHandle</code>。如果返回<code>null</code>表示没有效果。我们可以使用这个方法手动获取任何已被缓存的<code>RouteHandle</code>。框架不会自动管理它，需要我们手动实现。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">retrieve</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> DetachedRouteHandle <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="shoulddetach">shouldDetach<a class="anchor" href="#shoulddetach">§</a></h4>
<p>当离开当前路由时这个方法会被调用。如果返回<code>true</code>，<code>store</code>方法会被调用。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">shouldDetach</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="store">store<a class="anchor" href="#store">§</a></h4>
<p>这个方法当且仅当<code>shouldDetach</code>方法返回<code>true</code>时被调用。我们可以在这里具体实现如何缓存<code>RouteHandle</code>。在这个方法中缓存的内容将会被用在<code>retrieve</code>方法中。它提供了我们离开的路由和<code>RouteHandle</code>。</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">store</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> detachedTree<span class="token operator">:</span> DetachedRouteHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="%E7%A4%BA%E4%BE%8B">示例<a class="anchor" href="#%E7%A4%BA%E4%BE%8B">§</a></h3>
<p><code>src/services/route-strategy.service.ts</code>:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> RouteReuseStrategy<span class="token punctuation">,</span> DetachedRouteHandle<span class="token punctuation">,</span> ActivatedRouteSnapshot <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RouteStrategyService</span> <span class="token keyword">implements</span> <span class="token class-name">RouteReuseStrategy</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> handlers<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> DetachedRouteHandle <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token function">deleteRouteSnapshot</span><span class="token punctuation">(</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>RouteStrategyService<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">delete</span> RouteStrategyService<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * 判断当前路由是否需要缓存
   * 这个方法返回false时则路由发生变化并且其余方法会被调用
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>ActivatedRouteSnapshot<span class="token punctuation">}</span> future
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>ActivatedRouteSnapshot<span class="token punctuation">}</span> curr
   * <span class="token keyword">@returns</span> <span class="token punctuation">{</span>boolean<span class="token punctuation">}</span>
   * <span class="token keyword">@memberof</span> CacheRouteReuseStrategy
   */</span>
  <span class="token keyword">public</span> <span class="token function">shouldReuseRoute</span><span class="token punctuation">(</span>future<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> curr<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> future<span class="token punctuation">.</span>routeConfig <span class="token operator">===</span> curr<span class="token punctuation">.</span>routeConfig
      <span class="token operator">&amp;&amp;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * 当离开当前路由时这个方法会被调用
   * 如果返回 true 则 store 方法会被调用
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>ActivatedRouteSnapshot<span class="token punctuation">}</span> route
   * <span class="token keyword">@returns</span> <span class="token punctuation">{</span>boolean<span class="token punctuation">}</span>
   * <span class="token keyword">@memberof</span> CacheRouteReuseStrategy
   */</span>
  <span class="token keyword">public</span> <span class="token function">shouldDetach</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * 将路由写入缓存
   * 在这里具体实现如何缓存 RouteHandle
   * 提供了我们离开的路由和 RouteHandle
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>ActivatedRouteSnapshot<span class="token punctuation">}</span> route
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>DetachedRouteHandle<span class="token punctuation">}</span> detachedTree
   * <span class="token keyword">@memberof</span> CacheRouteReuseStrategy
   */</span>
  <span class="token keyword">public</span> <span class="token function">store</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">,</span> detachedTree<span class="token operator">:</span> DetachedRouteHandle<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    RouteStrategyService<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> detachedTree<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * 路由被导航 如果此方法返回 true 则触发 retrieve 方法
   * 如果返回 false 这个组件将会被重新创建
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>ActivatedRouteSnapshot<span class="token punctuation">}</span> route
   * <span class="token keyword">@returns</span> <span class="token punctuation">{</span>boolean<span class="token punctuation">}</span>
   * <span class="token keyword">@memberof</span> CacheRouteReuseStrategy
   */</span>
  <span class="token keyword">public</span> <span class="token function">shouldAttach</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>RouteStrategyService<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * 从缓存读取cached route
   * 提供当前路由的参数（刚打开的路由），并且返回一个缓存的 RouteHandle
   * 可以使用这个方法手动获取任何已被缓存的 RouteHandle
   * <span class="token keyword">@param</span> <span class="token punctuation">{</span>ActivatedRouteSnapshot<span class="token punctuation">}</span> route
   * <span class="token keyword">@returns</span> <span class="token punctuation">{</span>(DetachedRouteHandle | null)<span class="token punctuation">}</span>
   * <span class="token keyword">@memberof</span> CacheRouteReuseStrategy
   */</span>
  <span class="token keyword">public</span> <span class="token function">retrieve</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> DetachedRouteHandle <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> RouteStrategyService<span class="token punctuation">.</span>handlers<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">private</span> <span class="token function">getPath</span><span class="token punctuation">(</span>route<span class="token operator">:</span> ActivatedRouteSnapshot<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token comment">// tslint:disable-next-line: no-string-literal</span>
    <span class="token keyword">const</span> path <span class="token operator">=</span> route<span class="token punctuation">[</span><span class="token string">'_routerState'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>src/app/app.module.ts</code>:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> RouteReuseStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RouteStrategyService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../services/route-strategy.service'</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>
    providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span>
        <span class="token punctuation">{</span> provide<span class="token operator">:</span> RouteReuseStrategy<span class="token punctuation">,</span> useClass<span class="token operator">:</span> RouteStrategyService <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    bootstrap<span class="token operator">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre>
<p>以上示例运行时会缓存所有路由组件。
实现比如标签页效果时，关闭标签页，调用<code>RouteStrategyService</code>中的<code>deleteRouteSnapshot</code>方法删除已缓存的页面即可。</p>
<p><em>这里可能会有个问题，如果你不想用这个路由缓存了，请务必删除掉app.module.ts中的providers，而不是将RouteStrategyService的shouldReuseRoute始终return true；这样会出现路由跳转页面不跳转的问题，原因暂时未知。</em></p>
<h2 id="%E6%95%88%E6%9E%9C%E5%9B%BE">效果图<a class="anchor" href="#%E6%95%88%E6%9E%9C%E5%9B%BE">§</a></h2>
<p><a href="https://willern.gitee.io/2020/10/29/20201029/show.gif"><img src="https://willern.gitee.io/2020/10/29/20201029/show.gif" alt="img"></a></p>
<blockquote>
<p>文章转载于https://www.cnblogs.com/jehorn/p/11776730.html</p>
</blockquote></article></section><footer>Powered by&amp;nbsp;<a href="https://github.com/xcatliu/pagic" target="_blank">Pagic</a></footer><script src="https://cdn.pagic.org/react@16.13.1/umd/react.production.min.js"></script><script src="https://cdn.pagic.org/react-dom@16.13.1/umd/react-dom.production.min.js"></script><script type="module" src="/index.js"></script></body></html>